<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>TOTP令牌管理器</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="安全的双因素认证令牌管理器，支持离线使用">
  <meta name="theme-color" content="#0d6efd">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TOTP管理器">
  <meta name="msapplication-TileColor" content="#0d6efd">
  <meta name="msapplication-config" content="/browserconfig.xml">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- PWA Icons - 简化版本 -->
  <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
  
  <!-- 本地文件环境兼容性处理 -->
  <script>
    // 检测是否在本地文件环境中
    window.isLocalFile = window.location.protocol === 'file:';
    
    // 检测是否在Cloudflare Pages环境中
    window.isCloudflarePages = window.location.hostname.includes('pages.dev') || 
                               window.location.hostname.includes('cloudflare.com');
    
    // 如果是在本地文件环境中，设置一些兼容性标记
    if (window.isLocalFile) {
      // 在本地文件环境中，确保使用本地资源
      document.addEventListener('DOMContentLoaded', function() {
        // 延迟检查，确保CDN资源有足够时间加载
        setTimeout(function() {
          // 检查Vue是否加载成功
          if (typeof Vue === 'undefined') {
            const script = document.createElement('script');
            script.src = 'libs/vue.global.prod.js';
            document.body.appendChild(script);
          }
          
          // 检查Bootstrap是否加载成功
          if (typeof bootstrap === 'undefined') {
            const script = document.createElement('script');
            script.src = 'libs/bootstrap.bundle.min.js';
            document.body.appendChild(script);
          }
          
          // 检查CryptoJS是否加载成功
          if (typeof CryptoJS === 'undefined') {
            const script = document.createElement('script');
            script.src = 'libs/crypto-js.min.js';
            document.body.appendChild(script);
          }
        }, 3000); // 3秒后检查
      });
    } else {
      // 只有在非本地文件环境中才加载manifest
      const manifestLink = document.createElement('link');
      manifestLink.rel = 'manifest';
      manifestLink.href = 'manifest.json';
      manifestLink.onerror = function() {
        this.setAttribute('data-error', 'true');
      };
      document.head.appendChild(manifestLink);
    }
  </script>
  
    <style>
      .search-box-sticky {
        position: sticky;
        top: 0;
        z-index: 101;
        width: 100%;
        margin-bottom: 1.5rem !important;
        border-radius: 1.5rem;
        padding: 0.7rem 1.2rem;
        display: flex;
        align-items: center;
      }
      @media (max-width: 600px) {
        .search-box-sticky {
          flex-wrap: nowrap;
          padding: 0.3rem 0.3rem;
          gap: 0.2rem;
          border-radius: 0.8rem;
          min-height: unset;
          box-shadow: 0 2px 8px #0001;
        }
        .search-box-sticky input[type="text"] {
          font-size: 1rem;
          height: 2.1rem;
          padding: 0.2rem 0.6rem;
        }
        .search-box-sticky .btn, .search-box-sticky input[type="checkbox"] {
          height: 2.1rem;
          width: 2.1rem;
          min-width: 2.1rem;
          padding: 0;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .search-box-sticky .dropdown-menu {
          min-width: 8rem;
          font-size: 1rem;
        }
      }
      .token-card { margin-bottom: 1rem; }
      .token-info-row, .token-code-row { display: flex; align-items: center; justify-content: space-between; }
      .token-code { font-size: 1.5rem; font-family: monospace; cursor: pointer; user-select: all; }
      .totp-pie { vertical-align: middle; margin-left: 8px; }
      #toastArea { position: fixed; top: 1.2rem; right: 1.2rem; z-index: 2000; min-width: 220px; max-width: 90vw; }
      .toast .toast-body { word-break: break-all; white-space: pre-line; }
      .toast { box-shadow: 0 2px 12px rgba(0,0,0,0.08); border-radius: 8px; }
      @media (max-width: 600px) {
        #toastArea { top: 0.5rem; right: 0.5rem; left: 0.5rem; }
      }
      /* 移动端卡片滑动手势样式 */
      @media (max-width: 600px) {
        .token-card { position: relative; overflow: visible; }
      }
      /* ========== 动画与自适应主题 ========== */
      .token-card {
        transition: box-shadow 0.2s, transform 0.2s, background 0.2s;
      }
      .token-card:active {
        box-shadow: 0 2px 16px #0002;
        background: #f0f4ff;
      }
      .modal-content {
        transition: transform 0.2s, opacity 0.2s;
        transform: scale(0.98);
        opacity: 0.7;
      }
      .modal.show .modal-content {
        transform: scale(1);
        opacity: 1;
      }
      .toast {
        transition: opacity 0.3s, transform 0.3s;
        opacity: 0;
        transform: translateY(-10px);
      }
      .toast.show, .toast.fade.show {
        opacity: 1;
        transform: translateY(0);
      }
      /* ========== 主题切换样式 ========== */
      :root {
        --bg-primary-light: #f7f8fa;
        --bg-secondary-light: #ffffff;
        --text-primary-light: #333333;
        --text-secondary-light: #6c757d;
        --border-color-light: #e3e6ea;
        --card-shadow-light: 0 2px 8px rgba(0,0,0,0.08);
        --search-shadow-light: 0 4px 16px rgba(0,0,0,0.08);
  
        --bg-primary-dark: #181a1b;
        --bg-secondary-dark: #202325;
        --text-primary-dark: #e3e6ea;
        --text-secondary-dark: #b0b3b8;
        --border-color-dark: #33373a;
        --card-shadow-dark: 0 2px 8px rgba(0,0,0,0.4);
        --search-shadow-dark: 0 4px 16px rgba(0,0,0,0.4);
        --hover-bg-dark: #343a40;
      }
      
      .theme-light {
        --bg-primary: var(--bg-primary-light);
        --bg-secondary: var(--bg-secondary-light);
        --text-primary: var(--text-primary-light);
        --text-secondary: var(--text-secondary-light);
        --border-color: var(--border-color-light);
        --card-shadow: var(--card-shadow-light);
        --search-shadow: var(--search-shadow-light);
        --hover-bg: #f0f4ff;
      }
      
      .theme-dark {
        --bg-primary: var(--bg-primary-dark);
        --bg-secondary: var(--bg-secondary-dark);
        --text-primary: var(--text-primary-dark);
        --text-secondary: var(--text-secondary-dark);
        --border-color: var(--border-color-dark);
        --card-shadow: var(--card-shadow-dark);
        --search-shadow: var(--search-shadow-dark);
        --hover-bg: var(--hover-bg-dark);
      }
      
      /* 应用主题变量 */
      html {
        background-color: var(--bg-primary) !important;
      }
      body {
        background: var(--bg-primary) !important;
        color: var(--text-primary);
        transition: background-color 0.3s, color 0.3s;
        min-height: 100vh;
      }
      
      .card, .modal-content, .toast {
        background-color: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        border: 1px solid var(--border-color);
        box-shadow: var(--card-shadow);
      }
      .token-card:active {
        background: var(--hover-bg) !important;
      }
  
      .search-box-sticky {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        box-shadow: var(--search-shadow);
      }
      
      .form-control, .form-check-input {
        background-color: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      /* 多选框样式优化 */
      .form-check-input {
        width: 1.2em;
        height: 1.2em;
        margin-top: 0.1em;
        border: 2px solid var(--border-color) !important;
        border-radius: 0.25em;
        transition: all 0.2s ease;
      }
      
      .form-check-input:checked {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m6 10 3 3 6-6'/%3e%3c/svg%3e") !important;
        background-size: 0.8em 0.8em !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
      }
      
      .form-check-input:focus {
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
      }
      
      .form-check-input:hover {
        border-color: #0d6efd !important;
      }
      
      /* 日间模式下的特殊样式 */
      .theme-light .form-check-input {
        background-color: #ffffff !important;
        border-color: #6c757d !important;
      }
      
      .theme-light .form-check-input:checked {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.1) !important;
      }
      
      .theme-light .form-check-input:hover {
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.1) !important;
      }
      
      /* 暗黑模式下的样式 */
      .theme-dark .form-check-input {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .form-check-input:checked {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.3) !important;
      }
      
      .theme-dark .form-check-input:hover {
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.2) !important;
      }
      
      /* 单选按钮样式 */
      .form-check-input[type="radio"] {
        border-radius: 50% !important;
      }
      
      .form-check-input[type="radio"]:checked {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='2' fill='%23fff'/%3e%3c/svg%3e") !important;
        background-size: 0.6em 0.6em !important;
      }
      
      .form-control::placeholder {
        color: var(--text-secondary) !important;
      }
      
      .dropdown-menu {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
        box-shadow: var(--card-shadow) !important;
      }
      
      .dropdown-item {
        color: var(--text-primary) !important;
      }
      
      .dropdown-item:hover, .dropdown-item:focus, .dropdown-item:active {
        background-color: var(--hover-bg) !important;
        color: var(--text-primary) !important;
      }
      
      /* 修复移动端夜间模式下拉菜单 */
      .theme-dark .dropdown-menu {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .dropdown-item {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .dropdown-divider {
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .btn-close {
        filter: invert(1);
      }
      .theme-dark .bi-github,
      .theme-dark .btn-outline-dark .bi,
      .theme-dark .btn-outline-secondary .bi,
      .theme-dark .dropdown-item .bi,
      .theme-dark .dropdown-menu .bi {
        color: var(--text-primary) !important;
      }
      .theme-dark h2 {
        color: #f5f5f5;
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
      }
      
      .progress-bar { 
        background-color: #0d6efd; 
      }
      </style>
</head>
<body>
<div id="app"></div>
<div id="toastArea"></div>

<!-- Vue 3 本地优先 + CDN兜底 -->
<script src="libs/vue.global.prod.js" defer onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js'"></script>

<!-- Bootstrap 5 CSS 本地优先 + CDN兜底 -->
<link rel="stylesheet" href="libs/bootstrap.min.css" onerror="this.onerror=null;this.href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css'">

<!-- Bootstrap 5 JS 本地优先 + CDN兜底 -->
<script src="libs/bootstrap.bundle.min.js" defer onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'"></script>

<!-- CryptoJS 本地优先 + CDN兜底 -->
<script src="libs/crypto-js.min.js" defer onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js'"></script>

    <script>
// 删除重复的CSS动态加载，因为已经有静态link标签了

function showToast(msg, type = 'info', delay = 2200) {
  const toastArea = document.getElementById('toastArea');
  const id = 'toast-' + Date.now() + Math.random().toString(36).slice(2, 8);
  
  // 根据类型选择图标
  let iconSvg = '';
  if (type === 'success') {
    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.97a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>';
  } else if (type === 'danger') {
    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/></svg>';
  } else {
    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>';
  }
  
  const bg = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-info';
  const html = `
    <div id="${id}" class="toast align-items-center text-white ${bg} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="${delay}">
      <div class="d-flex">
        <div class="toast-body">${iconSvg} ${msg}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="关闭"></button>
      </div>
    </div>`;
  toastArea.insertAdjacentHTML('beforeend', html);
  const toastEl = document.getElementById(id);
  const toast = new bootstrap.Toast(toastEl);
  toast.show();
  toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}
window.showToast = showToast;

function showUndoToast(msg, onUndo, delay = 4000) {
  const toastArea = document.getElementById('toastArea');
  const id = 'toast-' + Date.now() + Math.random().toString(36).slice(2, 8);
  const html = `
    <div id="${id}" class="toast align-items-center text-white bg-danger border-0 mb-2 shadow" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="${delay}" style="min-width:260px;">
      <div class="d-flex align-items-center px-2 py-1">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/>
</svg>
        <div class="toast-body flex-grow-1 py-0" style="font-size:1.05rem;">${msg}</div>
        <button type="button" class="btn btn-sm btn-undo-toast ms-2 me-1" id="undoBtn${id}">撤销</button>
        <button type="button" class="btn-close btn-close-white ms-1" data-bs-dismiss="toast" aria-label="关闭"></button>
      </div>
    </div>
    <style>
      .btn-undo-toast {
        background: rgba(255,255,255,0.95);
        color: #d32f2f;
        border: none;
        border-radius: 1.2em;
        font-weight: 500;
        padding: 0.2em 1.1em;
        font-size: 1rem;
        transition: background 0.2s, color 0.2s;
      }
      .btn-undo-toast:hover {
        background: #fff;
        color: #b71c1c;
      }
    </style>
  `;
  toastArea.insertAdjacentHTML('beforeend', html);
  const toastEl = document.getElementById(id);
  const toast = new bootstrap.Toast(toastEl);
  toast.show();
  toastEl.querySelector(`#undoBtn${id}`).onclick = () => {
    toast.hide();
    if (onUndo) onUndo();
  };
  toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

const uuidv4 = () => (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : Math.random().toString(36).slice(2, 10) + Date.now());
// 等待DOM加载完成后再执行Vue应用
document.addEventListener('DOMContentLoaded', () => {
    const { createApp, ref, reactive, computed, onMounted, watch, nextTick, provide } = Vue;

// TOTP算法实现（兼容原生JS版）
    // 添加缓存机制提高性能
    const base32Cache = new Map();
    const hotpCache = new Map();
    
    // 添加时间戳验证
    function getCurrentCounter() {
      const period = 30;
      return Math.floor(Date.now() / 1000 / period);
    }
    
    function base32ToBytes(base32) {
      // 使用缓存避免重复计算
      if (base32Cache.has(base32)) {
        return base32Cache.get(base32);
      }
      
      const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let clean = base32.replace(/\s+/g, '').toUpperCase();
      while (clean.endsWith('=')) clean = clean.slice(0, -1);
      let buffer = 0, bitsLeft = 0, bytes = [];
      for (let i = 0; i < clean.length; i++) {
        const val = alphabet.indexOf(clean[i]);
        if (val === -1) return null;
        buffer = (buffer << 5) | val;
        bitsLeft += 5;
        while (bitsLeft >= 8) {
          bitsLeft -= 8;
          bytes.push((buffer >>> bitsLeft) & 0xff);
        }
      }
      if (bitsLeft > 0) bytes.push((buffer << (8 - bitsLeft)) & 0xff);
      const result = new Uint8Array(bytes);
      
      // 缓存结果（限制缓存大小）
      if (base32Cache.size < 100) {
        base32Cache.set(base32, result);
      }
      
      return result;
    }
    
    function leftPad(str, len, pad) {
      str = String(str);
      while (str.length < len) str = pad + str;
      return str;
    }
    
    function hotp(secretBytes, counter) {
      // 创建缓存键
      const cacheKey = `${secretBytes.join(',')}-${counter}`;
      
      // 验证缓存是否过期（检查counter是否过时）
      const currentCounter = getCurrentCounter();
      if (Math.abs(counter - currentCounter) > 1) {
        // 如果counter差距超过1个周期，清除相关缓存
        const keysToDelete = [];
        for (const [key, value] of hotpCache.entries()) {
          if (key.includes(secretBytes.join(','))) {
            keysToDelete.push(key);
          }
        }
        keysToDelete.forEach(key => hotpCache.delete(key));
      }
      
      if (hotpCache.has(cacheKey)) {
        return hotpCache.get(cacheKey);
      }
      
      // 兼容uuidv4和window.Crypto
      const key = secretBytes;
      const counterBytes = new Uint8Array(8);
      let tmp = counter;
      for (let i = 7; i >= 0; --i) {
        counterBytes[i] = tmp & 0xff;
        tmp = tmp >> 8;
      }
      
      // HMAC-SHA1
      const crypto = window.crypto || window.msCrypto;
      if (!crypto || !crypto.subtle) return '无效密钥';
      
      // 这里用同步polyfill（兼容性更好）
      // 直接用jsSHA1实现
      // 由于CDN限制，这里用window.CryptoJS（如有）
      if (window.CryptoJS) {
        const u8ToWordArray = (u8arr) => {
          var words = [], i = 0, len = u8arr.length;
          for (; i < len; i += 4) {
            var word = 0;
            if (i < len) word |= (u8arr[i] & 0xff) << 24;
            if (i + 1 < len) word |= (u8arr[i + 1] & 0xff) << 16;
            if (i + 2 < len) word |= (u8arr[i + 2] & 0xff) << 8;
            if (i + 3 < len) word |= (u8arr[i + 3] & 0xff);
            words.push(word);
          }
          return window.CryptoJS.lib.WordArray.create(words, len);
        };
        const keyWord = u8ToWordArray(key);
        const counterWord = u8ToWordArray(counterBytes);
        const hmac = window.CryptoJS.HmacSHA1(counterWord, keyWord);
        const hmacHex = hmac.toString(window.CryptoJS.enc.Hex);
        const hmacBytes = [];
        for (let i = 0; i < hmacHex.length; i += 2) hmacBytes.push(parseInt(hmacHex.substr(i, 2), 16));
        const offset = hmacBytes[hmacBytes.length - 1] & 0xf;
        const binCode = ((hmacBytes[offset] & 0x7f) << 24) |
          ((hmacBytes[offset + 1] & 0xff) << 16) |
          ((hmacBytes[offset + 2] & 0xff) << 8) |
          (hmacBytes[offset + 3] & 0xff);
        const result = leftPad(binCode % 1000000, 6, '0');
        
        // 缓存结果（限制缓存大小）
        if (hotpCache.size < 50) {
          hotpCache.set(cacheKey, result);
        }
        
        return result;
      }
      return '无效密钥';
    }
    
    function totp(secret, remainTick) {
      const bytes = base32ToBytes(secret);
      if (!bytes) return '无效密钥';
      const period = 30;
      const counter = Math.floor(Date.now() / 1000 / period);
      return hotp(bytes, counter);
    }
    
    // 智能缓存清理（每30秒清理一次，与TOTP周期同步）
    setInterval(() => {
      const currentCounter = getCurrentCounter();
      
      // 清理过期的HOTP缓存
      const keysToDelete = [];
      for (const [key, value] of hotpCache.entries()) {
        const keyParts = key.split('-');
        if (keyParts.length === 2) {
          const cachedCounter = parseInt(keyParts[1]);
          // 如果缓存的counter比当前counter小2个周期以上，则删除
          if (currentCounter - cachedCounter > 1) {
            keysToDelete.push(key);
          }
        }
      }
      keysToDelete.forEach(key => hotpCache.delete(key));
      
      // 清理Base32缓存（保持原有逻辑）
      if (base32Cache.size > 50) {
        const keys = Array.from(base32Cache.keys());
        for (let i = 0; i < keys.length / 2; i++) {
          base32Cache.delete(keys[i]);
        }
      }
      
      // 如果HOTP缓存仍然过大，清理一半
      if (hotpCache.size > 25) {
        const keys = Array.from(hotpCache.keys());
        for (let i = 0; i < keys.length / 2; i++) {
          hotpCache.delete(keys[i]);
        }
      }
    }, 30 * 1000); // 改为30秒，与TOTP周期同步

createApp({
  setup() {
    let undoTimer = null;
    // 全局状态
    const tokens = ref([]); // 令牌列表
    const selectedIds = ref([]); // 批量选择（数组）
    const recentlyDeleted = ref(null); // 撤销删除
    const toastList = ref([]); // Toast队列
    const search = ref('');
    const remain = ref(30 - (Math.floor(Date.now() / 1000) % 30));
    const isMobile = ref(window.innerWidth <= 600);
    const isMultiSelectMode = ref(false);
    let longPressTimer = null;

    // 定时刷新动态码与倒计时
    setInterval(() => {
      remain.value = 30 - (Math.floor(Date.now() / 1000) % 30);
    }, 1000);
    window.addEventListener('resize', () => {
      isMobile.value = window.innerWidth <= 600;
    });

    // 启动时加载本地存储
    onMounted(() => {
      try {
        const arr = JSON.parse(localStorage.getItem('totp_tokens') || '[]');
        if (Array.isArray(arr)) tokens.value = arr;
        
        // 加载备份历史
        const history = JSON.parse(localStorage.getItem('backup_history') || '[]');
        if (Array.isArray(history)) backupHistory.value = history;
        
        // 检查备份提醒
        checkBackupReminder();
        
        // 初始化主题
        applyTheme(currentTheme.value);
        
        // 监听系统主题变化
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', handleSystemThemeChange);
        
        
      } catch (error) {
        console.error('应用初始化失败:', error);
        showToast('应用初始化失败，请刷新页面重试', 'danger');
      }
    });
    // 数据备份提醒
    function checkBackupReminder() {
      const lastBackup = localStorage.getItem('last_backup_time');
      const tokenCount = tokens.value.length;
      
      if (tokenCount > 5 && (!lastBackup || Date.now() - parseInt(lastBackup) > 7 * 24 * 60 * 60 * 1000)) {
        // 超过5个令牌且7天未备份，显示提醒
        showToast('建议定期备份您的令牌数据，防止数据丢失', 'warning', 5000);
      }
    }
    
    // 优化的自动保存
    const debouncedSave = debounce((val) => {
      localStorage.setItem('totp_tokens', JSON.stringify(val));
      
      // 触发智能备份
      smartBackup();
    }, 1000);
    
    // tokens变更自动保存
    watch(tokens, (val) => {
      debouncedSave(val);
    }, { deep: true });

    // 令牌过滤
    const filteredTokens = computed(() => {
      if (!search.value.trim()) return tokens.value;
      const kw = search.value.trim().toLowerCase();
      return tokens.value.filter(t =>
          (t.userInfo && t.userInfo.toLowerCase().includes(kw)) ||
          (t.secret && t.secret.toLowerCase().includes(kw))
        );
    });

    // 全选checkbox联动
    const allSelected = computed({
      get() {
        return filteredTokens.value.length > 0 &&
          filteredTokens.value.every(t => selectedIds.value.includes(t.id));
      },
      set(val) {
        if (val) {
          // 只添加当前可见的
          selectedIds.value = filteredTokens.value.map(t => t.id);
        } else {
          // 只移除当前可见的
          selectedIds.value = selectedIds.value.filter(id => !filteredTokens.value.some(t => t.id === id));
        }
      }
    });

    // 令牌操作
    function selectAll() {
      selectedIds.value.splice(0, selectedIds.value.length, ...filteredTokens.value.map(t => t.id));
    }
    function clearSelect() {
      selectedIds.value.splice(0, selectedIds.value.length);
    }
    function deleteToken(id) {
  const idx = tokens.value.findIndex(t => t.id === id);
  if (idx === -1) return;
  const token = tokens.value[idx];
  tokens.value.splice(idx, 1);
  selectedIds.value.splice(selectedIds.value.indexOf(id), 1);
  recentlyDeleted.value = { token, idx };
  // 撤销Toast
  showUndoToast('令牌已删除', () => {
    // 撤销操作
    tokens.value.splice(recentlyDeleted.value.idx, 0, recentlyDeleted.value.token);
    recentlyDeleted.value = null;
    if (undoTimer) { clearTimeout(undoTimer); undoTimer = null; }
    // 重新保存
    localStorage.setItem('totp_tokens', JSON.stringify(tokens.value));
  });
  // 超时后才真正保存
  if (undoTimer) clearTimeout(undoTimer);
  undoTimer = setTimeout(() => {
    if (recentlyDeleted.value) {
      localStorage.setItem('totp_tokens', JSON.stringify(tokens.value));
      recentlyDeleted.value = null;
    }
  }, 4000);
}
function copyCode(code, event) {
  navigator.clipboard.writeText(code).then(() => {
    if (isMobile.value) {
      showToast('已复制动态码', 'success');
    } else {
      if (event && event.clientX && event.clientY) {
        const tip = document.createElement('div');
        tip.textContent = '已复制';
        tip.style.position = 'fixed';
        tip.style.top = (event.clientY - 30) + 'px';
        tip.style.left = (event.clientX - 20) + 'px';
        tip.style.background = '#222';
        tip.style.color = '#fff';
        tip.style.padding = '2px 10px';
        tip.style.borderRadius = '8px';
        tip.style.fontSize = '0.95rem';
        tip.style.zIndex = 9999;
        document.body.appendChild(tip);
        setTimeout(() => tip.remove(), 900);
      } else {
        showToast('已复制动态码', 'success');
      }
    }
  }).catch(err => {
    showToast('复制失败，请手动复制', 'danger');
    console.error('复制失败:', err);
  });
}

    // 进度条百分比
    const progressPercent = computed(() => 100 - remain.value * 100 / 30);

    // ========== 新增/编辑弹窗逻辑 ==========
    const activeModal = ref(null); // null, 'add', 'edit'
    const addForm = reactive({ userInfo: '', secret: '', error: '' });
    const editForm = reactive({ userInfo: '', secret: '', error: '' });
    const editingToken = ref(null);

    const modalTitle = computed(() => {
      if (activeModal.value === 'add') return '添加 TOTP 令牌';
      if (activeModal.value === 'edit') return '编辑 TOTP 令牌';
      if (activeModal.value === 'qr') return '导出二维码';
      if (activeModal.value === 'scan') return '批量导入';
      if (activeModal.value === 'gist') return 'GitHub Gist 云操作';
      if (activeModal.value === 'backup') return '备份管理';
      if (activeModal.value === 'export') {
        if (exportAction.value === 'gist-backup') return 'Gist 加密备份选项';
        if (exportAction.value === 'gist-restore') return 'Gist 加密恢复选项';
        return '本地导出选项';
      }
      return '';
    });

    function openAddModal() {
      addForm.userInfo = '';
      addForm.secret = '';
      addForm.error = '';
      activeModal.value = 'add';
      nextTick(() => {
        const input = document.querySelector('.modal.show input');
        if (input) input.focus();
      });
    }
    function addToken() {
      const userInfo = addForm.userInfo;
      const secret = addForm.secret;
      if (!secret || !base32ToBytes(secret)) {
        showToast('密钥不能为空且必须为有效 Base32 格式', 'danger');
        return false;
      }
      if (tokens.value.some(t => t.userInfo === userInfo && t.secret === secret)) {
        showToast('该令牌已存在，请勿重复添加', 'danger');
        return false;
      }
      tokens.value.push({ id: uuidv4(), userInfo, secret, created: Date.now() });
      showToast('添加成功', 'success');
      closeModal();
      return true;
    }
    function openEditModal(token) {
      editingToken.value = token;
      editForm.userInfo = token.userInfo;
      editForm.secret = token.secret;
      editForm.error = '';
      activeModal.value = 'edit';
      nextTick(() => {
        // 聚焦第一个输入框
        const input = document.querySelector('.modal.show input');
        if (input) input.focus();
      });
    }
    function closeModal() {
      activeModal.value = null;
      editingToken.value = null;
      // Reset forms to be safe
      addForm.userInfo = '';
      addForm.secret = '';
      addForm.error = '';
      editForm.userInfo = '';
      editForm.secret = '';
      editForm.error = '';
    }
    function saveEdit() {
      if (!editForm.secret || !base32ToBytes(editForm.secret)) {
        editForm.error = '密钥不能为空且必须为有效 Base32 格式';
        return;
      }
      // 检查是否与其它令牌重复（排除自己）
      if (tokens.value.some(t => t !== editingToken.value && t.userInfo === editForm.userInfo && t.secret === editForm.secret)) {
        editForm.error = '该令牌已存在，请勿重复';
        return;
      }
      editingToken.value.userInfo = editForm.userInfo;
      editingToken.value.secret = editForm.secret;
      showToast('保存成功', 'success');
      closeModal();
    }

    // ========== 二维码导出弹窗 ==========
    const qrToken = ref(null);
    async function openQRModal(token) {
      qrToken.value = token;
      activeModal.value = 'qr';
      nextTick(async () => {
        // 生成 otpauth URI
        const uri = `otpauth://totp/${encodeURIComponent(token.userInfo || 'TOTP')}?secret=${token.secret}&issuer=TOTPManager`;
        const qrDiv = document.getElementById('qrcode');
        if (qrDiv) {
          qrDiv.innerHTML = '';
          try {
            await loadKjua(); // 确保 kjua 已加载
            const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const qr = kjua({
              text: uri || 'empty',
              size: 220,
              render: 'svg',
              quiet: 2,
              background: isDark ? '#23272b' : '#fff',
              fill: isDark ? '#fff' : '#111'
            });
            qrDiv.appendChild(qr);
          } catch (e) {
            qrDiv.innerHTML = '<div class="text-danger">二维码生成失败</div>';
          }
        }
      });
    }

    // ========== 移动端动态码小圆饼倒计时 ==========
    function drawTotpPie(canvas, percent) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, 28, 28);
      // 背景灰色圆环
      ctx.beginPath();
      ctx.arc(14, 14, 12, 0, 2 * Math.PI);
      ctx.strokeStyle = '#eee';
      ctx.lineWidth = 4;
      ctx.stroke();
      // 剩余部分蓝色
      ctx.beginPath();
      ctx.arc(14, 14, 12, -Math.PI/2, -Math.PI/2 + 2 * Math.PI * percent, false);
      ctx.strokeStyle = '#0d6efd';
      ctx.lineWidth = 4;
      ctx.stroke();
    }
    function refreshTotpPies() {
      if (!isMobile.value) return;
      filteredTokens.value.forEach(token => {
        const canvas = document.getElementById('pie-' + token.id);
        if (!canvas) return;
        const period = 30;
        const now = Math.floor(Date.now() / 1000);
        const remain = period - (now % period);
        drawTotpPie(canvas, remain / period);
      });
    }
    onMounted(() => {
      setInterval(refreshTotpPies, 1000);
      nextTick(refreshTotpPies);
    });

    // ========== 批量导入多格式支持 ==========
    async function handleFiles(files) {
      try {
        showToast('正在处理文件，共' + files.length + '个', 'info', 1200);
        if (!files || !files.length) {
          showToast('未检测到文件', 'danger');
          return;
        }
        scanProgress.value = { total: files.length, success: 0, fail: 0, running: true };
        let success = 0, fail = 0;
        for (const file of files) {
          try {
            const ext = file.name.split('.').pop().toLowerCase();
            if (file.type.startsWith('image/')) {
              if (await processImageFile(file)) {
                success++;
              } else {
                fail++;
              }
            } else {
              const text = await readFileAsText(file);
              let ok = false;
              if (ext === 'json') {
                ok = importFromJSON(text);
              } else if (ext === 'csv') {
                ok = importFromCSV(text);
              } else if (ext === 'txt') {
                ok = importFromTxt(text);
                if (!ok) {
                  ok = importFromEncrypted(text);
                }
              }
              if (ok) success++; else fail++;
            }
          } catch (e) {
            fail++;
            handleError(e, `处理文件 "${file.name}"`);
          }
          scanProgress.value = { ...scanProgress.value, success, fail };
        }
        scanProgress.value.running = false;
        showToast('文件导入完成，成功:' + success + '，失败:' + fail, fail ? 'danger' : 'success');
        if (success > 0) closeModal();
      } catch (e) {
        handleError(e, '文件导入');
        scanProgress.value.running = false;
      }
    }
    function importFromJSON(text) {
      try {
        const arr = JSON.parse(text);
        if (!Array.isArray(arr)) {
          showToast('JSON 文件格式错误：根元素必须是数组', 'danger');
          return false;
        }
        let count = 0;
        let skipped = 0;
        let invalid = 0;
        arr.forEach(item => {
          if (item.secret) {
            let userInfo = item.userInfo || item.account || '';
            if (validateAndAddToken(userInfo, item.secret)) {
              count++;
            } else {
              skipped++;
            }
          } else {
            invalid++;
          }
        });
        if (invalid > 0) {
          showToast(`JSON导入：${invalid}个条目包含无效的密钥格式`, 'warning');
        }
        if (skipped > 0) {
          showToast(`JSON导入完成：新增${count}个，跳过${skipped}个已存在的令牌`, count > 0 ? 'success' : 'info');
        }
        return count > 0;
      } catch (e) {
        showToast('JSON 文件格式错误：' + e.message, 'danger');
        return false;
      }
    }
    function importFromTxt(text) {
      // 支持otpauth://URI批量导入
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      return processImportLines(lines, 'TXT导入');
    }
    function importFromCSV(text) {
      // 简单CSV: userInfo,secret
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      let count = 0;
      let skipped = 0;
      let invalid = 0;
      lines.forEach(line => {
        const parts = line.split(',');
        if (parts.length >= 2) {
          const userInfo = parts[0];
          const secret = parts[1];
          if (validateAndAddToken(userInfo, secret)) {
            count++;
          } else {
            skipped++;
          }
        } else {
          invalid++;
        }
      });
      if (invalid > 0) {
        showToast(`CSV导入：${invalid}行包含无效的密钥格式`, 'warning');
      }
      if (skipped > 0) {
        showToast(`CSV导入完成：新增${count}个，跳过${skipped}个已存在的令牌`, count > 0 ? 'success' : 'info');
      }
      return count > 0;
    }
    function importFromEncrypted(text) {
      const password = prompt('请输入加密密码：');
      if (!password) { showToast('已取消导入', 'info'); return false; }
      try {
        const decrypted = decryptData(text, password);
        if (!decrypted) {
          showToast('密码错误或文件损坏，请检查密码是否正确', 'danger');
          return false;
        }
        
        // 尝试解析为JSON
        let parsedData;
        try {
          parsedData = JSON.parse(decrypted);
        } catch (jsonError) {
          showToast('解密成功，但文件内容不是有效的JSON格式', 'warning');
          return false;
        }
        
        // 检查是否为数组
        if (!Array.isArray(parsedData)) {
          showToast('解密成功，但文件内容不是有效的令牌数组格式', 'warning');
          return false;
        }
        
        // 验证数组内容
        let count = 0;
        let skipped = 0;
        let invalid = 0;
        parsedData.forEach(item => {
          if (item.secret) {
            let userInfo = item.userInfo || item.account || '';
            if (validateAndAddToken(userInfo, item.secret)) {
              count++;
            } else {
              skipped++;
            }
          } else {
            invalid++;
          }
        });
        
        if (invalid > 0) {
          showToast(`加密文件导入：${invalid}个条目包含无效的密钥格式`, 'warning');
        }
        if (skipped > 0) {
          showToast(`加密文件导入完成：新增${count}个，跳过${skipped}个已存在的令牌`, count > 0 ? 'success' : 'info');
        } else if (count > 0) {
          showToast(`加密文件导入成功：新增${count}个令牌`, 'success');
        } else {
          showToast('加密文件导入完成：没有新增令牌', 'info');
        }
        
        return count > 0;
      } catch (e) {
        showToast('解密失败: ' + e.message, 'danger');
        return false;
      }
    }
    async function processImageFile(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = async evt => {
          const img = new window.Image();
          img.onload = async () => {
            await loadJsQR(); // 确保 jsQR 已加载
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code && code.data && handleQrData(code.data)) resolve(true);
            else {
              showToast(`图片 "${file.name}" 中未检测到有效的二维码`, 'info');
              resolve(false);
            }
          };
          img.onerror = () => {
            showToast(`图片 "${file.name}" 加载失败，请检查文件格式`, 'danger');
            resolve(false);
          };
          img.src = evt.target.result;
        };
        reader.onerror = () => {
          showToast(`文件 "${file.name}" 读取失败`, 'danger');
          resolve(false);
        };
        reader.readAsDataURL(file);
      });
    }
    function handleQrData(data) {
      if (data.startsWith('otpauth://totp/')) {
        try {
          // 处理 HTML 实体编码
          let decodedData = data.replace(/&amp;/g, '&');
          decodedData = decodedData.replace(/&nbsp;/g, ' ');
          
          const url = new URL(decodedData);
          const secret = url.searchParams.get('secret');
          const issuer = url.searchParams.get('issuer');
          
          // 解析用户信息
          let userInfo = decodeURIComponent(url.pathname.slice(1));
          
          // 通用处理逻辑：提取真正的用户标识符
          let finalUserInfo = userInfo;
          
          // 1. 如果路径包含冒号，提取冒号后的部分
          if (userInfo.includes(':')) {
            const colonIndex = userInfo.indexOf(':');
            const afterColon = userInfo.substring(colonIndex + 1);
            // 如果冒号后是邮箱格式，使用冒号后的部分
            if (afterColon.includes('@')) {
              finalUserInfo = afterColon;
            }
          }
          
          // 2. 如果用户信息包含空格和邮箱，保留完整格式
          if (finalUserInfo.includes(' ') && finalUserInfo.includes('@')) {
            // 检查是否包含括号，如果有括号，保持完整格式
            if (finalUserInfo.includes('(') && finalUserInfo.includes(')')) {
              // 保持原样，不进行分割
              finalUserInfo = finalUserInfo;
            } else {
              // 如果没有括号，将剩余部分作为描述
              const parts = finalUserInfo.split(' ');
              const emailPart = parts.find(part => part.includes('@'));
              const otherParts = parts.filter(part => !part.includes('@')).join(' ');
              if (emailPart && otherParts) {
                finalUserInfo = `${emailPart} (${otherParts})`;
              } else {
                finalUserInfo = emailPart || finalUserInfo;
              }
            }
          }
          
          // 3. 处理 issuer 信息
          if (issuer && issuer !== 'TOTPManager' && issuer !== 'TOTP Manager') {
            // 检查是否重复
            if (!finalUserInfo.startsWith(issuer + ':') && issuer !== finalUserInfo) {
              finalUserInfo = `${issuer}: ${finalUserInfo}`;
            }
          }
          
          // 调试信息
          return validateAndAddToken(finalUserInfo, secret);
        } catch (e) {
          showToast(`无效的 otpauth URI 格式: ${e.message}`, 'danger');
          return false;
        }
      }
      return false;
    }

    // ========== 摄像头扫码功能 ==========
    const cameraActive = ref(false);
    let videoStream = null;
    function startCamera() {
      const video = document.getElementById('qrVideo');
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast('此浏览器不支持摄像头调用', 'danger');
        return;
      }
      navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}}).then(stream => {
        videoStream = stream;
        video.srcObject = stream;
        video.setAttribute('playsinline', true);
        video.play();
        cameraActive.value = true;
        scanLoop();
      }).catch(err => {
        showToast('无法访问摄像头: ' + err.name, 'danger');
      });
    }
    function stopCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      cameraActive.value = false;
      const video = document.getElementById('qrVideo');
      if (video) video.srcObject = null;
    }
    async function scanLoop() {
      const video = document.getElementById('qrVideo');
      if (!videoStream || !cameraActive.value) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        await loadJsQR(); // 确保 jsQR 已加载
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code && code.data) {
          if (handleQrData(code.data)) {
            showToast('扫码导入成功！', 'success');
            // 询问用户是否继续扫描
            if (confirm('✅ 扫码成功！\n\n是否继续扫描其他二维码？\n\n• 点击"确定"继续扫描\n• 点击"取消"停止扫描')) {
              // 继续扫描，延迟一下避免重复扫描同一个码
              setTimeout(scanLoop, 2000);
            } else {
              stopCamera();
              showToast('已停止扫码', 'info');
              closeModal(); // 关闭批量扫码导入弹窗
            }
            return;
          }
        }
      }
      setTimeout(scanLoop, 500);
    }

    // ========== Gist 备份/恢复 ==========
    const gistPAT = ref(localStorage.getItem('gist_pat') || '');
    const gistError = ref('');
    function openGistModal() {
      gistPAT.value = localStorage.getItem('gist_pat') || '';
      gistError.value = '';
      activeModal.value = 'gist';
    }
    function saveGistPAT() {
      if (!gistPAT.value) {
        gistError.value = 'PAT不能为空';
        return;
      }
      localStorage.setItem('gist_pat', gistPAT.value);
      closeModal();
      showToast('PAT已保存', 'success');
    }
    // 获取加密/解密密码的通用函数
    async function getEncryptPassword(defaultPwd) {
      return new Promise((resolve) => {
        const useCustom = confirm('是否自定义加密密码？\n点击"确定"自定义，点击"取消"使用默认密码（如PAT）');
        if (useCustom) {
          const pwd = prompt('请输入自定义加密密码：');
          if (!pwd) {
            showToast('已取消操作', 'info');
            return resolve(null);
          }
          resolve(pwd);
        } else {
          if (!defaultPwd) {
            showToast('默认密码不能为空', 'danger');
            return resolve(null);
          }
          resolve(defaultPwd);
        }
      });
    }
    // Gist加密备份
    async function backupToGist() {
      if (!gistPAT.value) { showToast('请先配置PAT', 'danger'); return; }
      try {
        const data = JSON.stringify(tokens.value, null, 2);
        const password = await getEncryptPassword(gistPAT.value);
        if (!password) { showToast('已取消备份', 'info'); return; }
        const encrypted = encryptData(data, password);
        // 查找是否已有 totp_tokens_encrypted.txt 的 gist，只用第一个
        const res = await fetch('https://api.github.com/gists', {
          headers: { Authorization: 'token ' + gistPAT.value }
        });
        if (!res.ok) throw new Error('获取 Gist 列表失败');
        const gists = await res.json();
        let gist = gists.find(g => g.files && g.files['totp_tokens_encrypted.txt']);
        let gistId;
        if (gist) {
          gistId = gist.id;
        } else {
          // 没有则新建
          const createRes = await fetch('https://api.github.com/gists', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: 'token ' + gistPAT.value },
            body: JSON.stringify({
              description: 'TOTP 令牌加密自动备份',
              public: false,
              files: { 'totp_tokens_encrypted.txt': { content: encrypted } }
            })
          });
          if (!createRes.ok) throw new Error('创建 Gist 失败');
          const data = await createRes.json();
          gistId = data.id;
        }
        // 更新 gist，只更新 totp_tokens_encrypted.txt 文件内容
        const patchRes = await fetch('https://api.github.com/gists/' + gistId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', Authorization: 'token ' + gistPAT.value },
          body: JSON.stringify({
            files: { 'totp_tokens_encrypted.txt': { content: encrypted } }
          })
        });
        if (!patchRes.ok) throw new Error('Gist 更新失败');
        showToast('Gist 加密备份成功！', 'success');
        closeModal();
      } catch (e) {
        showToast('Gist 备份失败：' + e.message, 'danger');
      }
    }
    // Gist加密恢复
    async function restoreFromGist() {
      if (!gistPAT.value) { showToast('请先配置PAT', 'danger'); return; }
      try {
        // 查找 gist
        const res = await fetch('https://api.github.com/gists', {
          headers: { Authorization: 'token ' + gistPAT.value }
        });
        if (!res.ok) throw new Error('获取 Gist 列表失败');
        const gists = await res.json();
        const gist = gists.find(g => g.files && g.files['totp_tokens_encrypted.txt']);
        if (!gist) throw new Error('未找到 totp_tokens_encrypted.txt Gist');
        const rawUrl = gist.files['totp_tokens_encrypted.txt'].raw_url;
        const fileRes = await fetch(rawUrl);
        if (!fileRes.ok) throw new Error('下载 Gist 文件失败');
        let arr = null;
        if (password) {
          const encrypted = await fileRes.text();
          const decrypted = decryptData(encrypted, password);
          if (!decrypted) throw new Error('密码错误或文件损坏');
          arr = JSON.parse(decrypted);
        } else {
          arr = await fileRes.json();
        }
        if (!Array.isArray(arr)) throw new Error('Gist 文件内容格式错误');
        tokens.value = arr;
        showToast('Gist 恢复成功！', 'success');
        closeModal();
      } catch (e) {
        showToast('Gist 恢复失败：' + e.message, 'danger');
      }
    }

    // ========== 批量操作 ==========
    function batchDelete() {
      if (!selectedIds.value.length) { showToast('请先选择要删除的令牌', 'info'); return; }
      if (!confirm(`确定要删除选中的${selectedIds.value.length}个令牌吗？`)) return;
      const before = tokens.value.length;
      tokens.value = tokens.value.filter(t => !selectedIds.value.includes(t.id));
      selectedIds.value = [];
      showToast(`已删除${before - tokens.value.length}个令牌`, 'success');
    }

    // 批量扫码导入弹窗和进度
    const scanProgress = reactive({ total: 0, success: 0, fail: 0, running: false });
    const pasteText = ref(''); // 添加粘贴文本的响应式数据
    
    function openScanModal() {
      activeModal.value = 'scan';
      scanProgress.total = 0;
      scanProgress.success = 0;
      scanProgress.fail = 0;
      scanProgress.running = false;
      pasteText.value = ''; // 清空粘贴文本
    }
    
    // 公共令牌验证和添加函数
    function validateAndAddToken(userInfo, secret) {
      if (secret && base32ToBytes(secret)) {
        if (!tokens.value.some(t => t.userInfo === userInfo && t.secret === secret)) {
          tokens.value.push({ id: uuidv4(), userInfo, secret, created: Date.now() });
          return true;
        } else {
          showToast(`令牌 "${userInfo}" 已存在，跳过导入`, 'info');
          return false;
        }
      } else {
        showToast(`无效的 TOTP 密钥格式: ${userInfo || '未知'}`, 'danger');
        return false;
      }
    }
    
    // 公共导入处理函数
    function processImportLines(lines, sourceName = '导入') {
      let count = 0;
      let skipped = 0;
      let invalid = 0;
      
      lines.forEach((line, index) => {
        if (line.startsWith('otpauth://totp/')) {
          if (handleQrData(line)) {
            count++;
          } else {
            skipped++;
          }
        } else {
          invalid++;
        }
      });
      
      if (count > 0) {
        showToast(`${sourceName}成功：新增${count}个令牌${skipped > 0 ? `，跳过${skipped}个` : ''}`, 'success');
        return true;
      } else if (skipped > 0) {
        showToast(`${sourceName}完成：跳过${skipped}个已存在的令牌`, 'info');
        return false;
      } else if (invalid > 0) {
        showToast(`${sourceName}失败：${invalid}行不是有效的otpauth URI格式`, 'danger');
        return false;
      } else {
        showToast(`${sourceName}内容为空或格式不正确`, 'warning');
        return false;
      }
    }
    
    // 处理粘贴导入
    function handlePasteImport() {
      if (!pasteText.value.trim()) {
        showToast('请先粘贴 otpauth 链接', 'warning');
        return;
      }
      
      const lines = pasteText.value.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const success = processImportLines(lines, '粘贴导入');
      if (success) {
        pasteText.value = ''; // 清空文本框
      }
    }

    // 修复：watch(showScanModal, ...) 必须在 setup 内部
    watch(activeModal, (newVal, oldVal) => {
      if (oldVal === 'scan' && newVal !== 'scan') {
        stopCamera();
      }
    });

    // 提供showToast到组件内
    provide('showToast', showToast);

    // ========== 批量扫码导入弹窗拖拽与摄像头完善 ==========
    // 文件拖拽相关方法
    function triggerFileInput() {
      const input = document.getElementById('qrImgInput');
      if (input) input.click();
    }
    
    function handleDragOver(event) {
      const dropZone = document.getElementById('qrDropZone');
      if (dropZone) {
        dropZone.classList.add('bg-info', 'bg-opacity-10');
        dropZone.style.borderColor = '#0d6efd';
        dropZone.style.boxShadow = '0 0 0 0.25rem rgba(13, 110, 253, 0.25)';
      }
    }
    
    function handleDragLeave(event) {
      const dropZone = document.getElementById('qrDropZone');
      if (dropZone) {
        dropZone.classList.remove('bg-info', 'bg-opacity-10');
        dropZone.style.borderColor = '';
        dropZone.style.boxShadow = '';
      }
    }
    
    function handleFileDrop(event) {
      const dropZone = document.getElementById('qrDropZone');
      if (dropZone) {
        dropZone.classList.remove('bg-info', 'bg-opacity-10');
        dropZone.style.borderColor = '';
        dropZone.style.boxShadow = '';
      }
      
      if (event.dataTransfer && event.dataTransfer.files && event.dataTransfer.files.length) {
        handleFiles(event.dataTransfer.files);
      }
    }

    onMounted(() => {
      // 初始化UI相关操作
    });
    watch(filteredTokens, () => {
      // 令牌列表变化时的处理
    });

    function onCardTouchStart(token) {
      if (isMultiSelectMode.value) return;
      longPressTimer = setTimeout(() => {
        isMultiSelectMode.value = true;
        if (!selectedIds.value.includes(token.id)) {
          selectedIds.value.push(token.id);
        }
      }, 500);
    }
    function onCardTouchEnd() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    }
    function onCardTouchCancel() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    }
    function exitMultiSelectMode() {
      isMultiSelectMode.value = false;
      selectedIds.value = [];
    }

    const swipeStates = reactive({});
    let touchStartX = 0;
    let touchStartY = 0;
    let touchMoved = false;
    function onCardSwipeStart(token, event) {
      if (!isMobile.value) return;
      touchMoved = false;
      touchStartX = 0;
      touchStartY = 0;
      swipeStates[token.id] = swipeStates[token.id] || { offset: 0, deleting: false };
      if (event.touches && event.touches.length === 1) {
        touchStartX = event.touches[0].clientX;
        touchStartY = event.touches[0].clientY;
      }
    }
    function onCardSwipeMove(token, event) {
      if (!isMobile.value) return;
      if (!event.touches || event.touches.length !== 1) return;
      const dx = event.touches[0].clientX - touchStartX;
      const dy = event.touches[0].clientY - touchStartY;
      if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {
        touchMoved = true;
        swipeStates[token.id].offset = dx;
        event.preventDefault();
      }
    }
    function onCardSwipeEnd(token) {
      if (!isMobile.value) return;
      const offset = swipeStates[token.id].offset;
      if (touchMoved && offset < -140) {
        // 左滑直接删除
        deleteToken(token.id);
        swipeStates[token.id].offset = 0;
        swipeStates[token.id].deleting = false;
      } else if (touchMoved && offset > 140) {
        // 右滑进入编辑界面
        openEditModal(token);
        swipeStates[token.id].offset = 0;
        swipeStates[token.id].deleting = false;
      } else {
        swipeStates[token.id].offset = 0;
        swipeStates[token.id].deleting = false;
      }
      touchMoved = false;
    }
    function onCardSwipeCancel(token) {
      if (!isMobile.value) return;
      swipeStates[token.id].offset = 0;
      swipeStates[token.id].deleting = false;
      touchMoved = false;
    }

    // 统一导出/备份弹窗状态
    const showExportModal = ref(false);
    const exportType = ref('none'); // 'none' | 'custom'
    const exportPassword = ref('');
    const exportAction = ref(''); // 'gist-backup' | 'gist-restore' | 'gist' | 'local'

    function openExportModal(action) {
      exportType.value = 'none';
      exportPassword.value = '';
      exportAction.value = action; // 'gist-backup' | 'gist-restore' | 'gist' | 'local'
      activeModal.value = 'export';
    }

    async function confirmExport() {
      let password = exportType.value === 'custom' ? exportPassword.value : null;
      if (exportType.value === 'custom' && !password) {
        showToast('请输入加密密码', 'danger');
        return;
      }
      if (exportType.value === 'custom' && password.trim() === '') {
        showToast('加密密码不能为空', 'danger');
        return;
      }
      if (exportAction.value === 'local') {
        // 本地导出
        const arr = tokens.value.filter(t => selectedIds.value.includes(t.id));
        let data = JSON.stringify(arr, null, 2);
        if (password) {
          data = encryptData(data, password);
        }
        const blob = new Blob([data], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = password ? 'totp_tokens_encrypted.txt' : 'totp_tokens.json';
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        showToast(password ? '已导出加密文件' : '已导出明文文件', 'success');
        closeModal();
      } else if (exportAction.value === 'gist') {
        // ...原 gist 备份逻辑（可删除或保留）...
      } else if (exportAction.value === 'gist-backup') {
        // Gist 加密备份
        try {
          const data = JSON.stringify(tokens.value, null, 2);
          let content = data;
          let filename = 'totp_tokens.json';
          if (password) {
            content = encryptData(data, password);
            filename = 'totp_tokens_encrypted.txt';
          }
          const res = await fetch('https://api.github.com/gists', {
            headers: { Authorization: 'token ' + gistPAT.value }
          });
          if (!res.ok) throw new Error('获取 Gist 列表失败');
          const gists = await res.json();
          let gist = gists.find(g => g.files && g.files[filename]);
          let gistId;
          if (gist) {
            gistId = gist.id;
          } else {
            const createRes = await fetch('https://api.github.com/gists', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: 'token ' + gistPAT.value },
              body: JSON.stringify({
                description: password ? 'TOTP 令牌加密自动备份' : 'TOTP 令牌明文自动备份',
                public: false,
                files: { [filename]: { content } }
              })
            });
            if (!createRes.ok) throw new Error('创建 Gist 失败');
            const data = await createRes.json();
            gistId = data.id;
          }
          const patchRes = await fetch('https://api.github.com/gists/' + gistId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', Authorization: 'token ' + gistPAT.value },
            body: JSON.stringify({
              files: { [filename]: { content } }
            })
          });
          if (!patchRes.ok) throw new Error('Gist 更新失败');
          showToast(password ? 'Gist 加密备份成功！' : 'Gist 明文备份成功！', 'success');
          closeModal();
        } catch (e) {
          showToast('Gist 备份失败：' + e.message, 'danger');
        }
      } else if (exportAction.value === 'gist-restore') {
        // Gist 加密恢复
        try {
          const res = await fetch('https://api.github.com/gists', {
            headers: { Authorization: 'token ' + gistPAT.value }
          });
          if (!res.ok) throw new Error('获取 Gist 列表失败');
          // 优先找加密文件
          let gist = null;
          let filename = '';
          if (password) {
            gist = (await res.json()).find(g => g.files && g.files['totp_tokens_encrypted.txt']);
            filename = 'totp_tokens_encrypted.txt';
          } else {
            gist = (await res.json()).find(g => g.files && g.files['totp_tokens.json']);
            filename = 'totp_tokens.json';
          }
          if (!gist) throw new Error('未找到对应 Gist 文件');
          const rawUrl = gist.files[filename].raw_url;
          const fileRes = await fetch(rawUrl);
          if (!fileRes.ok) throw new Error('下载 Gist 文件失败');
          let arr = null;
          if (password) {
            const encrypted = await fileRes.text();
            const decrypted = decryptData(encrypted, password);
            if (!decrypted) throw new Error('密码错误或文件损坏');
            arr = JSON.parse(decrypted);
          } else {
            arr = await fileRes.json();
          }
          if (!Array.isArray(arr)) throw new Error('Gist 文件内容格式错误');
          tokens.value = arr;
          showToast('Gist 恢复成功！', 'success');
          closeModal();
        } catch (e) {
          showToast('Gist 恢复失败：' + e.message, 'danger');
        }
      }
    }

    // 防抖函数
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // 防抖的搜索
    const debouncedSearch = debounce((value) => {
      search.value = value;
    }, 300);

    // 键盘快捷键支持
    function handleKeydown(event) {
      // 检查当前焦点是否在输入框或文本区域内
      const activeElement = document.activeElement;
      const isInInput = activeElement && (
        activeElement.tagName === 'INPUT' || 
        activeElement.tagName === 'TEXTAREA' || 
        activeElement.isContentEditable
      );
      
      // Ctrl/Cmd + N: 新增令牌
      if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
        event.preventDefault();
        openAddModal();
      }
      // Ctrl/Cmd + F: 聚焦搜索框
      if ((event.ctrlKey || event.metaKey) && event.key === 'f') {
        event.preventDefault();
        const searchInput = document.querySelector('.search-box-sticky input');
        if (searchInput) searchInput.focus();
      }
      // Ctrl/Cmd + A: 全选（仅当不在输入框内时）
      if ((event.ctrlKey || event.metaKey) && event.key === 'a' && !isInInput) {
        event.preventDefault();
        if (filteredTokens.value.length > 0) {
          selectAll();
        }
      }
      // Escape: 退出多选模式
      if (event.key === 'Escape' && isMultiSelectMode.value) {
        exitMultiSelectMode();
      }
    }
    
    // 监听键盘事件
    onMounted(() => {
      document.addEventListener('keydown', handleKeydown);
    });
    
    function checkLocalStorage() {
      try {
        const testKey = '__health_check__';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        return { status: 'healthy', message: 'localStorage 正常' };
      } catch (e) {
        return { status: 'error', message: 'localStorage 异常: ' + e.message };
      }
    }
    
    function checkMemoryUsage() {
      if ('memory' in performance) {
        const memory = performance.memory;
        const usagePercent = (memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100;
        return {
          status: usagePercent > 80 ? 'warning' : 'healthy',
          message: `内存使用率: ${usagePercent.toFixed(1)}%`
        };
      }
      return { status: 'unknown', message: '无法检测内存使用' };
    }
    
    function checkNetworkConnectivity() {
      return navigator.onLine 
        ? { status: 'healthy', message: '网络连接正常' }
        : { status: 'error', message: '网络连接断开' };
    }
    
    function checkTokensIntegrity() {
      try {
        const tokenCount = tokens.value.length;
        const validTokens = tokens.value.filter(t => t.secret && base32ToBytes(t.secret));
        const invalidCount = tokenCount - validTokens.length;
        
        return {
          status: invalidCount > 0 ? 'warning' : 'healthy',
          message: `令牌总数: ${tokenCount}, 有效: ${validTokens.length}, 无效: ${invalidCount}`
        };
      } catch (e) {
        return { status: 'error', message: '令牌完整性检查失败: ' + e.message };
      }
    }

    // 智能备份和恢复机制
    const backupHistory = ref([]); // 备份历史
    const maxBackupHistory = 10; // 最多保留10个备份
    
    // 创建备份
    function createBackup(reason = '手动备份') {
      const backup = {
        id: Date.now(),
        timestamp: Date.now(),
        reason: reason,
        data: JSON.parse(JSON.stringify(tokens.value)), // 深拷贝
        tokenCount: tokens.value.length
      };
      
      backupHistory.value.unshift(backup);
      
      // 限制备份历史数量
      if (backupHistory.value.length > maxBackupHistory) {
        backupHistory.value = backupHistory.value.slice(0, maxBackupHistory);
      }
      
      // 保存到 localStorage
      localStorage.setItem('backup_history', JSON.stringify(backupHistory.value));
      localStorage.setItem('last_backup_time', Date.now().toString());
      
      return backup;
    }
    
    // 从备份恢复
    function restoreFromBackup(backupId) {
      const backup = backupHistory.value.find(b => b.id === backupId);
      if (!backup) {
        showToast('备份不存在', 'danger');
        return false;
      }
      
      if (confirm(`确定要恢复到 ${new Date(backup.timestamp).toLocaleString()} 的备份吗？\n当前数据将被覆盖！`)) {
        tokens.value = JSON.parse(JSON.stringify(backup.data));
        showToast(`已恢复到 ${backup.reason} 备份，共 ${backup.tokenCount} 个令牌`, 'success');
        return true;
      }
      return false;
    }
    
    // 删除备份
    function deleteBackup(backupId) {
      backupHistory.value = backupHistory.value.filter(b => b.id !== backupId);
      localStorage.setItem('backup_history', JSON.stringify(backupHistory.value));
      showToast('备份已删除', 'success');
    }

    // 误删恢复功能
    function recoverDeletedTokens() {
      if (backupHistory.value.length === 0) {
        showToast('没有可用的备份记录', 'warning');
        return;
      }
      
      // 找到最近的备份
      const latestBackup = backupHistory.value[0];
      const currentTokens = new Set(tokens.value.map(t => `${t.userInfo}:${t.secret}`));
      const backupTokens = latestBackup.data.filter(t => !currentTokens.has(`${t.userInfo}:${t.secret}`));
      
      if (backupTokens.length === 0) {
        showToast('没有发现被删除的令牌', 'info');
        return;
      }
      
      if (confirm(`发现 ${backupTokens.length} 个可能被删除的令牌，是否恢复？`)) {
        backupTokens.forEach(token => {
          if (!tokens.value.some(t => t.userInfo === token.userInfo && t.secret === token.secret)) {
            tokens.value.push({ ...token, id: uuidv4(), created: Date.now() });
          }
        });
        showToast(`已恢复 ${backupTokens.length} 个令牌`, 'success');
      }
    }
    
    // 智能备份策略
    function smartBackup() {
      const now = Date.now();
      const lastBackup = localStorage.getItem('last_backup_time');
      const tokenCount = tokens.value.length;
      
      // 备份条件：
      // 1. 令牌数量变化超过2个
      // 2. 距离上次备份超过1小时
      // 3. 令牌数量超过5个
      if (tokenCount > 5) {
        const shouldBackup = !lastBackup || 
          (now - parseInt(lastBackup) > 60 * 60 * 1000) || // 1小时
          Math.abs(tokenCount - (backupHistory.value[0]?.tokenCount || 0)) > 2; // 变化超过2个
        
        if (shouldBackup) {
          createBackup('自动备份');
        }
      }
    }
    
    
    // 备份管理弹窗状态
    function openBackupModal() {
      activeModal.value = 'backup';
    }

    // 主题切换功能
    const currentTheme = ref(localStorage.getItem('theme') || 'auto'); // auto, light, dark
    const isDarkMode = ref(false);
    
    // 应用主题
    function applyTheme(theme) {
      const themes = ['light', 'dark'];
      if (theme === 'auto') {
        const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.body.className = isDark ? 'theme-dark' : 'theme-light';
        isDarkMode.value = isDark;
      } else {
        document.body.className = `theme-${theme}`;
        isDarkMode.value = theme === 'dark';
      }
      currentTheme.value = theme;
      localStorage.setItem('theme', theme);
    }
    
    // 切换主题
    function toggleTheme() {
      const themes = ['auto', 'light', 'dark'];
      const currentIndex = themes.indexOf(currentTheme.value);
      const nextTheme = themes[(currentIndex + 1) % themes.length];
      applyTheme(nextTheme);
    }
    
    // 处理系统主题变化
    function handleSystemThemeChange(e) {
      if (currentTheme.value === 'auto') {
        applyTheme('auto');
      }
    }
    
    // 显示变更详情
    function showChangeDetails(backup) {
      if (!backup.changes || backup.changes.length === 0) {
        showToast('没有变更详情', 'info');
        return;
      }
      
      let details = `备份时间: ${new Date(backup.timestamp).toLocaleString()}\n`;
      details += `变更数量: ${backup.changes.length}\n\n`;
      
      backup.changes.forEach((change, index) => {
        details += `${index + 1}. `;
        switch (change.type) {
          case 'add':
            details += `新增: ${change.token.userInfo || '未命名'}\n`;
            break;
          case 'delete':
            details += `删除: ${change.token.userInfo || '未命名'}\n`;
            break;
          case 'modify':
            details += `修改: ${change.token.userInfo || '未命名'}\n`;
            if (change.previous.userInfo !== change.token.userInfo) {
              details += `  用户信息: "${change.previous.userInfo}" → "${change.token.userInfo}"\n`;
            }
            break;
        }
      });
      
      alert(details);
    }
    
    // 显示错误详情
    function showErrorDetails(log) {
      let details = `错误时间: ${new Date(log.timestamp).toLocaleString()}\n`;
      details += `错误类型: ${log.context}\n`;
      details += `错误信息: ${log.message}\n`;
      details += `页面地址: ${log.url}\n`;
      details += `用户代理: ${log.userAgent}\n`;
      
      if (log.stack) {
        details += `\n堆栈信息:\n${log.stack}\n`;
      }
      
      if (log.args) {
        details += `\n参数信息:\n${JSON.stringify(log.args, null, 2)}\n`;
      }
      
      alert(details);
    }
    
    // 在用到jsQR和kjua的地方分别await loadJsQR()和await loadKjua()
    // 例如：
    // await loadJsQR();
    // const code = jsQR(...);
    // await loadKjua();
    // const qr = kjua(...);

    // Bootstrap Icons建议用SVG inline方式替换

    // 1. 通用加密/解密函数
    function encryptData(data, password) {
      return CryptoJS.AES.encrypt(data, password).toString();
    }
    function decryptData(text, password) {
      return CryptoJS.AES.decrypt(text, password).toString(CryptoJS.enc.Utf8);
    }
    // 2. 通用文件读取函数
    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }
    // 3. Toast复用（showToast, showUndoToast已较好，可保持）
    // 4. 在导出/导入/备份/恢复等相关地方用encryptData/decryptData/readFileAsText替换原有CryptoJS和FileReader调用

    return {
      tokens, selectedIds, allSelected, recentlyDeleted, toastList, search, remain, isMobile,
      filteredTokens, selectAll, clearSelect, deleteToken, copyCode, totp, progressPercent,
      activeModal, modalTitle, addForm, editForm, editingToken,
      openAddModal, addToken, openEditModal, saveEdit, closeModal,
      qrToken, openQRModal,
      scanProgress, openScanModal, handleFiles,
      cameraActive, startCamera, stopCamera,
      gistPAT, gistError, openGistModal, saveGistPAT, backupToGist, restoreFromGist,
      batchDelete,
      isMultiSelectMode,
      onCardTouchStart,
      onCardTouchEnd,
      onCardTouchCancel,
      exitMultiSelectMode,
      swipeStates,
      onCardSwipeStart,
      onCardSwipeMove,
      onCardSwipeEnd,
      onCardSwipeCancel,
      exportType,
      exportPassword,
      exportAction,
      openExportModal,
      confirmExport,
      pasteText,
      handlePasteImport,
      debouncedSearch,
      triggerFileInput,
      handleDragOver,
      handleDragLeave,
      handleFileDrop,
      backupHistory,
      maxBackupHistory,
      createBackup,
      restoreFromBackup,
      deleteBackup,
      recoverDeletedTokens,
      smartBackup,
      openBackupModal,
      currentTheme,
      isDarkMode,
      applyTheme,
      toggleTheme,
      handleSystemThemeChange,
      showChangeDetails,
    };
  },
  template: `
    <div class="container py-3">
      <h2 class="mb-4"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-shield-lock" viewBox="0 0 16 16">
  <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/>
  <path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99a1.5 1.5 0 1 1 2-1.415z"/>
</svg> TOTP令牌管理器</h2>
      <div class="search-box-sticky">
        <input v-model="search" class="form-control flex-grow-1 me-1" :placeholder="(selectedIds.length ? '搜索...（已选' + selectedIds.length + '项）' : '搜索... (Ctrl+F)')" style="min-width:0;">
        <input type="checkbox" class="form-check-input me-1" v-model="allSelected" :title="'全选 (Ctrl+A)'" v-if="!isMobile || isMultiSelectMode">
        <button class="btn btn-success btn-sm me-1" @click="openAddModal" title="新增 (Ctrl+N)"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
  <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
</svg></button>
        <template v-if="!isMobile">
          <!-- PC端平铺 -->
          <button class="btn btn-outline-info btn-sm me-1" @click="openScanModal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-qr-code-scan" viewBox="0 0 16 16">
  <path d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z"/>
  <path d="M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z"/>
  <path d="M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z"/>
  <path d="M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 2h-1v1h-2v1h3zm-4 2v-1H8v1z"/>
  <path d="M12 9h2V8h-2z"/>
</svg></button>
          <button class="btn btn-outline-warning btn-sm me-1" @click="openBackupModal" title="备份管理"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock-history" viewBox="0 0 16 16">
  <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022zm2.004.45a7 7 0 0 0-.985-.299l.219-.976q.576.129 1.126.342zm1.37.71a7 7 0 0 0-.439-.27l.493-.87a8 8 0 0 1 .979.654l-.615.789a7 7 0 0 0-.418-.302zm1.834 1.79a7 7 0 0 0-.653-.796l.724-.69q.406.429.747.91zm.744 1.352a7 7 0 0 0-.214-.468l.893-.45a8 8 0 0 1 .45 1.088l-.95.313a7 7 0 0 0-.179-.483m.53 2.507a7 7 0 0 0-.1-1.025l.985-.17q.1.58.116 1.17zm-.131 1.538q.05-.254.081-.51l.993.123a8 8 0 0 1-.23 1.155l-.964-.267q.069-.247.12-.501m-.952 2.379q.276-.436.486-.908l.914.405q-.24.54-.555 1.038zm-.964 1.205q.183-.183.35-.378l.758.653a8 8 0 0 1-.401.432z"/>
  <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0z"/>
  <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5"/>
</svg></button>
          <button class="btn btn-outline-dark btn-sm me-1" @click="openGistModal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
  <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8"/>
</svg></button>
          <button class="btn btn-outline-danger btn-sm me-1" @click="batchDelete"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
</svg></button>
          <button class="btn btn-outline-success btn-sm me-1" @click="openExportModal('local')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
  <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
  <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/>
</svg></button>
          <button class="btn btn-outline-primary btn-sm" @click="toggleTheme" :title="'主题: ' + (currentTheme === 'auto' ? '自动' : currentTheme === 'dark' ? '深色' : '浅色')">
            <svg v-if="currentTheme === 'auto'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-circle-half" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M8 1v14a7 7 0 0 1 0-14z"/>
            </svg>
            <svg v-else-if="isDarkMode" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.732 3.5a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0zm2.5 0a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0zm2.5 0a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0z"/>
            </svg>
            <svg v-else xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
            </svg>
          </button>
        </template>
        <template v-else>
          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown" title="更多">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
  <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"/>
</svg>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" @click.prevent="openScanModal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-qr-code-scan" viewBox="0 0 16 16">
  <path d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z"/>
  <path d="M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z"/>
  <path d="M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z"/>
  <path d="M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 2h-1v1h-2v1h3zm-4 2v-1H8v1z"/>
  <path d="M12 9h2V8h-2z"/>
</svg> 批量扫码导入</a></li>
              <li><a class="dropdown-item" href="#" @click.prevent="openBackupModal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock-history" viewBox="0 0 16 16">
  <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022zm2.004.45a7 7 0 0 0-.985-.299l.219-.976q.576.129 1.126.342zm1.37.71a7 7 0 0 0-.439-.27l.493-.87a8 8 0 0 1 .979.654l-.615.789a7 7 0 0 0-.418-.302zm1.834 1.79a7 7 0 0 0-.653-.796l.724-.69q.406.429.747.91zm.744 1.352a7 7 0 0 0-.214-.468l.893-.45a8 8 0 0 1 .45 1.088l-.95.313a7 7 0 0 0-.179-.483m.53 2.507a7 7 0 0 0-.1-1.025l.985-.17q.1.58.116 1.17zm-.131 1.538q.05-.254.081-.51l.993.123a8 8 0 0 1-.23 1.155l-.964-.267q.069-.247.12-.501m-.952 2.379q.276-.436.486-.908l.914.405q-.24.54-.555 1.038zm-.964 1.205q.183-.183.35-.378l.758.653a8 8 0 0 1-.401.432z"/>
  <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0z"/>
  <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5"/>
</svg> 备份管理</a></li>
              <li><a class="dropdown-item" href="#" @click.prevent="openGistModal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
  <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8"/>
</svg> Gist云备份</a></li>
              <li><a class="dropdown-item" href="#" @click.prevent="batchDelete"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
</svg> 批量删除</a></li>
              <li><a class="dropdown-item" href="#" @click.prevent="openExportModal('local')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
  <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
  <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/>
</svg> 批量导出JSON</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" @click.prevent="toggleTheme">
                <svg v-if="currentTheme === 'auto'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M8 1v14a7 7 0 0 1 0-14z"/>
                </svg>
                <svg v-else-if="isDarkMode" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.732 3.5a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0zm2.5 0a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0zm2.5 0a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0z"/>
                </svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
                </svg> 
                切换主题 ({{currentTheme === 'auto' ? '自动' : currentTheme === 'dark' ? '深色' : '浅色'}})
              </a></li>
            </ul>
          </div>
          <button v-if="isMultiSelectMode" class="btn btn-outline-secondary btn-sm ms-2" @click="exitMultiSelectMode"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
  <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
</svg> 取消多选</button>
        </template>
      </div>
      <div v-if="filteredTokens.length === 0" class="alert alert-warning">暂无令牌</div>
      <div v-else>
        <div v-for="token in filteredTokens" :key="token.id" class="card token-card" :id="'card-' + token.id" :data-id="token.id"
          @touchstart="onCardTouchStart(token); onCardSwipeStart(token, $event)"
          @touchmove="onCardSwipeMove(token, $event)"
          @touchend="onCardTouchEnd(); onCardSwipeEnd(token)"
          @touchcancel="onCardTouchCancel(); onCardSwipeCancel(token)"
          :style="isMobile && swipeStates[token.id] && swipeStates[token.id].offset ? ('transform: translateX(' + swipeStates[token.id].offset + 'px); transition: 0.2s;') : ''">
          <div class="card-body" v-if="isMobile">
            <div class="token-info-row" style="position:relative;">
              <input v-if="isMultiSelectMode" type="checkbox" class="form-check-input me-2 select-cbx" v-model="selectedIds" :value="token.id">
              <span>{{token.userInfo || '未命名'}}<span v-if="!token.secret" class="badge bg-danger ms-2">无密钥</span></span>
              <button
                v-if="swipeStates[token.id] && swipeStates[token.id].deleting"
                class="btn btn-danger btn-sm ms-2"
                @click="deleteToken(token.id)"
                style="position:absolute; right:10px; top:50%; transform:translateY(-50%); z-index:2;"
              >删除</button>
            </div>
            <div class="token-code-row mt-2">
              <span class="token-code" :data-copy="totp(token.secret, remain)" @click="copyCode(totp(token.secret, remain), $event)">{{totp(token.secret, remain)}}</span>
              <canvas class="totp-pie" :id="'pie-' + token.id" width="28" height="28"></canvas>
            </div>
            <div class="d-flex mt-2 gap-2" v-if="!isMobile">
              <button class="btn btn-outline-primary btn-sm flex-fill" @click="openEditModal(token)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
  <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
</svg> 编辑</button>
              <button class="btn btn-outline-danger btn-sm flex-fill" @click="deleteToken(token.id)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
</svg> 删除</button>
              <button class="btn btn-outline-success btn-sm flex-fill" @click="openQRModal(token)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-qr-code" viewBox="0 0 16 16">
  <path d="M2 2h2v2H2z"/>
  <path d="M6 0v6H0V0zM5 1H1v4h4zM4 12H2v2h2z"/>
  <path d="M6 10v6H0v-6zm-5 1v4h4v-4zm11-9h2v2h-2z"/>
  <path d="M10 0v6h6V0zm5 1v4h-4V1zM8 1V0h1v2H8v2H7V1zm0 5V4h1v2zM6 8V7h1V6h1v2h1V7h5v1h-4v1H7V8zm0 0v1H2V8H1v1H0V7h3v1zm10 1h-1V7h1zm-1 0h-1v2h2v-1h-1zm-4 0h2v1h-1v1h-1zm2 3v-1h-1v1h-1v1H9v1h3v-2zm0 0h3v1h-2v1h-1zm-4-1v1h1v-2H7v1z"/>
  <path d="M7 12h1v3h4v1H7zm9 2v2h-3v-1h2v-1z"/>
</svg> 导出二维码</button>
            </div>
          </div>
          <div class="card-body d-flex align-items-center gap-3" v-else>
            <input type="checkbox" class="form-check-input me-2 select-cbx" v-model="selectedIds" :value="token.id">
            <div class="token-info flex-grow-1" :title="token.userInfo">{{token.userInfo || '未命名'}}<span v-if="!token.secret" class="badge bg-danger ms-2">无密钥</span></div>
            <span class="token-code" :data-copy="totp(token.secret, remain)" @click="copyCode(totp(token.secret, remain), $event)">{{totp(token.secret, remain)}}</span>
            <div class="progress flex-grow-1 me-1" style="max-width:80px;">
              <div class="progress-bar" :style="{width: progressPercent + '%'}"></div>
            </div>
            <span class="token-timer" style="min-width:36px;">{{remain}} 秒</span>
            <div class="token-actions ms-2 flex-shrink-0 d-flex gap-1">
              <button class="btn btn-outline-primary btn-sm" @click="openEditModal(token)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
  <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
</svg> 编辑</button>
              <button class="btn btn-outline-danger btn-sm" @click="deleteToken(token.id)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
</svg> 删除</button>
              <button class="btn btn-outline-success btn-sm" @click="openQRModal(token)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-qr-code" viewBox="0 0 16 16">
  <path d="M2 2h2v2H2z"/>
  <path d="M6 0v6H0V0zM5 1H1v4h4zM4 12H2v2h2z"/>
  <path d="M6 10v6H0v-6zm-5 1v4h4v-4zm11-9h2v2h-2z"/>
  <path d="M10 0v6h6V0zm5 1v4h-4V1zM8 1V0h1v2H8v2H7V1zm0 5V4h1v2zM6 8V7h1V6h1v2h1V7h5v1h-4v1H7V8zm0 0v1H2V8H1v1H0V7h3v1zm10 1h-1V7h1zm-1 0h-1v2h2v-1h-1zm-4 0h2v1h-1v1h-1zm2 3v-1h-1v1h-1v1H9v1h3v-2zm0 0h3v1h-2v1h-1zm-4-1v1h1v-2H7v1z"/>
  <path d="M7 12h1v3h4v1H7zm9 2v2h-3v-1h2v-1z"/>
</svg> 导出二维码</button>
            </div>
          </div>
        </div>
      </div>
      <!-- 通用新增/编辑弹窗 -->
      <div class="modal fade" tabindex="-1" :class="{show: activeModal === 'add' || activeModal === 'edit'}" style="display: block;" v-if="activeModal === 'add' || activeModal === 'edit'">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">{{ modalTitle }}</h5>
              <button type="button" class="btn-close" @click="closeModal"></button>
            </div>
            <!-- 新增表单 -->
            <form v-if="activeModal === 'add'" @submit.prevent="addToken">
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">用户信息</label>
                  <input type="text" class="form-control" v-model="addForm.userInfo" placeholder="如：邮箱/账号/描述">
                </div>
                <div class="mb-3">
                  <label class="form-label">密钥（Base32）</label>
                  <input type="text" class="form-control" v-model="addForm.secret" placeholder="如：JBSWY3DPEHPK3PXP">
                  <div class="form-text">请确保密钥为 Base32 格式</div>
                </div>
                <div class="error-message">{{addForm.error}}</div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @click="closeModal">取消</button>
                <button type="submit" class="btn btn-primary">添加</button>
              </div>
            </form>
            <!-- 编辑表单 -->
            <form v-if="activeModal === 'edit'" @submit.prevent="saveEdit">
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">用户信息</label>
                  <input type="text" class="form-control" v-model="editForm.userInfo">
                </div>
                <div class="mb-3">
                  <label class="form-label">密钥（Base32）</label>
                  <input type="text" class="form-control" v-model="editForm.secret">
                  <div class="form-text">请确保密钥为 Base32 格式</div>
                </div>
                <div class="error-message text-danger">{{editForm.error}}</div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @click="closeModal">取消</button>
                <button type="submit" class="btn btn-primary">保存</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- 二维码导出弹窗 -->
      <div class="modal fade" tabindex="-1" :class="{show: activeModal === 'qr'}" style="display: block;" v-if="activeModal === 'qr'">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">导出二维码</h5>
              <button type="button" class="btn-close" @click="closeModal"></button>
            </div>
            <div class="modal-body text-center">
              <div id="qrcode"></div>
              <div class="mt-3" style="font-size:1.1rem;font-weight:500;color:#333;word-break:break-all;">{{qrToken?.userInfo || '未命名'}}</div>
              <div class="mt-2">可用 Google Authenticator 等扫码导入</div>
            </div>
          </div>
        </div>
      </div>
      <!-- 批量扫码导入弹窗（图片） -->
      <div class="modal fade" tabindex="-1" :class="{show:activeModal === 'scan'}" style="display: block;" v-if="activeModal === 'scan'">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">{{ modalTitle }}</h5>
              <button type="button" class="btn-close" @click="closeModal"></button>
            </div>
            <div class="modal-body">
              <!-- 直接粘贴导入 -->
              <div class="mb-3">
                <label class="form-label">直接粘贴 otpauth 链接</label>
                <textarea class="form-control" rows="3" placeholder="粘贴一个或多个 otpauth://totp/ 链接，每行一个" v-model="pasteText"></textarea>
                <div class="mt-2">
                  <button class="btn btn-primary btn-sm" @click="handlePasteImport">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0"/>
  <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
  <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
</svg> 导入粘贴的链接
                  </button>
                </div>
                <div class="form-text small">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
  <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
</svg> 支持多种格式：otpauth://totp/邮箱?secret=密钥、otpauth://totp/服务:邮箱?secret=密钥等
                </div>
              </div>
              
              <hr class="my-3">
              
              
              <div id="qrDropZone" class="mb-3 p-4 border border-2 border-dashed rounded text-center" style="background:#f8f9fa;cursor:pointer;transition:all 0.2s;" @click="triggerFileInput" @dragover.prevent="handleDragOver" @dragleave.prevent="handleDragLeave" @drop.prevent="handleFileDrop">
                <div class="text-muted">
  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-cloud-upload" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383"/>
    <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z"/>
  </svg>
</div>
                <div class="mt-2">拖拽图片文件到此处，或点击此区域选择</div>
              </div>
              <input type="file" accept=".png,.jpg,.jpeg,.bmp,.gif,.webp,.json,.csv,.txt,image/*" id="qrImgInput" class="form-control mb-2" multiple @change="e=>handleFiles(e.target.files)" style="display:none">
              <div class="form-text mb-2">可选择/拖拽多种文件，支持二维码图片（PNG、JPG）、JSON、CSV、TXT（otpauth://URI）等格式</div>
              <div class="text-center mb-3">
                <video id="qrVideo" :style="{display: cameraActive ? '' : 'none', width: '100%', maxWidth: '300px'}" autoplay playsinline></video>
                <div class="mt-2">
                  <button class="btn btn-outline-secondary btn-sm me-2" v-if="!cameraActive" @click="startCamera"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-video" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M0 5a2 2 0 0 1 2-2h7.5a2 2 0 0 1 1.983 1.738l3.11-1.382A1 1 0 0 1 16 4.269v7.462a1 1 0 0 1-1.406.913l-3.111-1.382A2 2 0 0 1 9.5 13H2a2 2 0 0 1-2-2zm11.5 5.175 3.5 1.556V4.269l-3.5 1.556zM2 4a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h7.5a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1z"/>
</svg> 摄像头扫码</button>
                  <button class="btn btn-outline-secondary btn-sm" v-if="cameraActive" @click="stopCamera"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
  <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
</svg> 停止扫码</button>
                </div>
                <div v-if="cameraActive" class="mt-2 text-muted small">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
  <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
</svg> 正在扫描二维码...
                </div>
              </div>
              <div class="progress mb-2" v-if="scanProgress.total">
                <div class="progress-bar" role="progressbar" :style="{width: (scanProgress.success+scanProgress.fail)*100/scanProgress.total+'%'}"></div>
              </div>
              <div v-if="scanProgress.total" class="mb-2">
                总文件数: {{scanProgress.total}}，成功: {{scanProgress.success}}，失败: {{scanProgress.fail}}
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Gist配置弹窗 -->
      <div class="modal fade" tabindex="-1" :class="{show:activeModal === 'gist'}" style="display: block;" v-if="activeModal === 'gist'">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">{{ modalTitle }}</h5>
              <button type="button" class="btn-close" @click="closeModal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label">GitHub PAT（gist权限）</label>
                <input type="text" class="form-control" v-model="gistPAT" placeholder="ghp_xxx">
                <div class="form-text">仅保存在本地浏览器，不上传服务器</div>
                <div class="error-message">{{gistError}}</div>
              </div>
              <div class="alert alert-info mt-2" style="font-size:0.98rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-shield-lock" viewBox="0 0 16 16">
  <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/>
  <path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99a1.5 1.5 0 1 1 2-1.415z"/>
</svg> 支持加密备份和加密恢复，推荐自定义密码加密，遗失密码将无法恢复数据。
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" @click="closeModal">取消</button>
              <button type="button" class="btn btn-primary" @click="saveGistPAT">保存PAT</button>
              <button type="button" class="btn btn-success" @click="openExportModal('gist-backup')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-upload" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383"/>
  <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z"/>
</svg> 加密备份
              </button>
              <button type="button" class="btn btn-info" @click="openExportModal('gist-restore')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-download" viewBox="0 0 16 16">
  <path d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383"/>
  <path d="M7.646 15.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 14.293V5.5a.5.5 0 0 0-1 0v8.793l-2.146-2.147a.5.5 0 0 0-.708.708z"/>
</svg> 加密恢复
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- 统一导出/备份弹窗 -->
      <div class="modal fade" tabindex="-1" :class="{show: activeModal === 'export'}" style="display: block;" v-if="activeModal === 'export'">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">{{ modalTitle }}</h5>
              <button type="button" class="btn-close" @click="closeModal"></button>
            </div>
            <div class="modal-body">
              <div class="form-check mb-2">
                <input class="form-check-input" type="radio" id="exportNone" value="none" v-model="exportType">
                <label class="form-check-label" for="exportNone">不加密（明文）</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="radio" id="exportCustom" value="custom" v-model="exportType">
                <label class="form-check-label" for="exportCustom">自定义密码加密</label>
              </div>
              <div v-if="exportType==='custom'" class="mb-2">
                <input type="password" class="form-control" v-model="exportPassword" placeholder="请输入加密密码">
              </div>
              <div class="form-text">
                <template v-if="exportAction==='gist-backup'">
                  请选择是否加密备份到Gist，推荐自定义密码加密，遗失密码将无法恢复数据！
                </template>
                <template v-else-if="exportAction==='gist-restore'">
                  请选择是否用密码解密恢复Gist备份，若为明文备份可直接恢复。
                </template>
                <template v-else>
                  如选择加密，请牢记密码，遗失将无法恢复数据！
                </template>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" @click="closeModal">取消</button>
              <button type="button" class="btn btn-primary" @click="confirmExport">确定</button>
            </div>
          </div>
        </div>
      </div>
      <!-- 备份管理弹窗 -->
      <div class="modal fade" tabindex="-1" :class="{show:activeModal === 'backup'}" style="display: block;" v-if="activeModal === 'backup'">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock-history" viewBox="0 0 16 16">
  <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022zm2.004.45a7 7 0 0 0-.985-.299l.219-.976q.576.129 1.126.342zm1.37.71a7 7 0 0 0-.439-.27l.493-.87a8 8 0 0 1 .979.654l-.615.789a7 7 0 0 0-.418-.302zm1.834 1.79a7 7 0 0 0-.653-.796l.724-.69q.406.429.747.91zm.744 1.352a7 7 0 0 0-.214-.468l.893-.45a8 8 0 0 1 .45 1.088l-.95.313a7 7 0 0 0-.179-.483m.53 2.507a7 7 0 0 0-.1-1.025l.985-.17q.1.58.116 1.17zm-.131 1.538q.05-.254.081-.51l.993.123a8 8 0 0 1-.23 1.155l-.964-.267q.069-.247.12-.501m-.952 2.379q.276-.436.486-.908l.914.405q-.24.54-.555 1.038zm-.964 1.205q.183-.183.35-.378l.758.653a8 8 0 0 1-.401.432z"/>
  <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0z"/>
  <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5"/>
</svg> {{ modalTitle }}</h5>
              <button type="button" class="btn-close" @click="closeModal"></button>
            </div>
            <div class="modal-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <button class="btn btn-primary btn-sm me-2" @click="createBackup('手动备份')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
  <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
</svg> 创建备份
                  </button>
                  <button class="btn btn-warning btn-sm me-2" @click="recoverDeletedTokens">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
  <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
</svg> 恢复误删令牌
                  </button>
                </div>
                <div>
                  <span class="badge bg-secondary">{{backupHistory.length}}/{{maxBackupHistory}}</span>
                </div>
              </div>
              
              <div v-if="backupHistory.length === 0" class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
  <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
</svg> 暂无备份记录，建议定期创建备份以防数据丢失
              </div>
              
              <div v-else class="table-responsive">
                <table class="table table-sm table-hover">
                  <thead class="sticky-top bg-light">
                    <tr>
                      <th>备份时间</th>
                      <th>备份类型</th>
                      <th>原因</th>
                      <th>令牌数量</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="backup in backupHistory" :key="backup.id">
                      <td>{{new Date(backup.timestamp).toLocaleString()}}</td>
                      <td>
                        <span class="badge bg-primary">完整备份</span>
                      </td>
                      <td>{{backup.reason}}</td>
                      <td>{{backup.tokenCount}} 个</td>
                      <td>
                        <button class="btn btn-outline-primary btn-sm me-1" @click="restoreFromBackup(backup.id)" title="恢复到此备份">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
  <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
</svg>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" @click="deleteBackup(backup.id)" title="删除备份">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
</svg>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div class="alert alert-warning mt-3" style="font-size:0.9rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle" viewBox="0 0 16 16">
  <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>
  <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
</svg> 
                <strong>备份说明：</strong>
                <ul class="mb-0 mt-1">
                  <li><strong>完整备份：</strong>包含所有令牌数据的完整快照</li>
                  <li><strong>自动备份：</strong>令牌数量变化超过2个或超过1小时未备份时自动创建</li>
                  <li><strong>手动备份：</strong>用户主动创建的备份</li>
                  <li><strong>恢复功能：</strong>可以恢复到任意备份点，当前数据将被覆盖</li>
                  <li><strong>误删恢复：</strong>智能检测并恢复被删除的令牌</li>
                  <li><strong>存储位置：</strong>本地浏览器存储，清除浏览器数据会丢失备份</li>
                  <li><strong>建议：</strong>重要数据请使用 Gist 云备份或定期导出文件</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `,
}).mount('#app');
});

// 动态加载jsQR
function loadJsQR() {
  return new Promise((resolve, reject) => {
    if (window.jsQR) return resolve(window.jsQR);
    
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
    script.onload = () => {
      resolve(window.jsQR);
    };
    script.onerror = () => {
      // CDN失败，尝试加载本地文件
      const localScript = document.createElement('script');
      localScript.src = 'libs/jsQR.js';
      localScript.onload = () => {
        resolve(window.jsQR);
      };
      localScript.onerror = () => {
        console.error('jsQR库加载失败');
        reject(new Error('jsQR库加载失败'));
      };
      document.body.appendChild(localScript);
    };
    document.body.appendChild(script);
  });
}

// 动态加载kjua
function loadKjua() {
  return new Promise((resolve, reject) => {
    if (window.kjua) return resolve(window.kjua);
    
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/kjua@0.1.1/dist/kjua.min.js';
    script.onload = () => {
      resolve(window.kjua);
    };
    script.onerror = () => {
      // CDN失败，尝试加载本地文件
      const localScript = document.createElement('script');
      localScript.src = 'libs/kjua.min.js';
      localScript.onload = () => {
        resolve(window.kjua);
      };
      localScript.onerror = () => {
        console.error('kjua库加载失败');
        reject(new Error('kjua库加载失败'));
      };
      document.body.appendChild(localScript);
    };
    document.body.appendChild(script);
  });
}

// 全局错误处理
function handleError(error, context = '操作') {
  console.error(`${context}错误:`, error);
  showToast(`${context}失败: ${error.message || '未知错误'}`, 'danger');
}

</script>

<!-- PWA 脚本 -->
<script src="pwa.js"></script>

</body>
</html>
